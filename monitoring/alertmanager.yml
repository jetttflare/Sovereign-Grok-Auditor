# Alertmanager Configuration
# ==========================
# Route alerts to appropriate channels

global:
  # Global SMTP settings
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@grokapp.io'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  
  # Slack settings
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Route configuration
route:
  # Default receiver
  receiver: 'default-receiver'
  
  # Group alerts by alertname and service
  group_by: ['alertname', 'service']
  
  # Wait time before sending first notification
  group_wait: 30s
  
  # Wait time before sending updates
  group_interval: 5m
  
  # Time to wait before resending
  repeat_interval: 4h
  
  # Child routes for specific alert types
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h
      
    # Security alerts - dedicated channel
    - match:
        category: security
      receiver: 'security-receiver'
      group_wait: 10s
      repeat_interval: 30m
      
    # Warning alerts - standard notification
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 1m
      repeat_interval: 4h

# Receiver definitions
receivers:
  # Default receiver - Slack + Email
  - name: 'default-receiver'
    slack_configs:
      - channel: '#grokapp-alerts'
        send_resolved: true
        title: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          {{ end }}
    email_configs:
      - to: 'oncall@grokapp.io'
        send_resolved: true

  # Critical receiver - PagerDuty + Slack + Email
  - name: 'critical-receiver'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
        severity: critical
    slack_configs:
      - channel: '#grokapp-critical'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
    email_configs:
      - to: 'oncall@grokapp.io,engineering-leads@grokapp.io'
        send_resolved: true

  # Security receiver - dedicated security channel
  - name: 'security-receiver'
    slack_configs:
      - channel: '#grokapp-security'
        send_resolved: true
        color: 'danger'
        title: 'ðŸ” SECURITY ALERT: {{ .GroupLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Action Required:* See runbook
          *Runbook:* {{ .Annotations.runbook_url }}
          {{ end }}
    email_configs:
      - to: 'security@grokapp.io'
        send_resolved: true

  # Warning receiver - standard notifications
  - name: 'warning-receiver'
    slack_configs:
      - channel: '#grokapp-alerts'
        send_resolved: true
        color: 'warning'
        title: 'âš ï¸ Warning: {{ .GroupLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

# Inhibition rules - prevent alert storms
inhibit_rules:
  # If critical, silence warning for same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']
  
  # If service is down, silence performance alerts for that service
  - source_match:
      alertname: 'GrokAPIDown'
    target_match:
      service: 'grok_api'
    equal: ['service']

# Templates for notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
